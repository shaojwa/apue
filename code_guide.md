
## 编码建议
#### 平台性能组 v0.824

## 目录
- [说明](#说明)
- [命名](#命名)
- [格式](格式)
- [头文件](头文件)
- [函数](函数)
- [日志](#日志)
- [其他](#其他)


#### 说明
这是一份组内的编码建议，目的是让代码有更加一致的风格，使得组内代码更加易于维护，同时问题单流程能更加有效。

#### 参考
这份主要的参考[Google C++ 编码规范](https://google.github.io/styleguide/cppguide.html)

## 代码最合适的位置
任何代码，都只是各种方案中的一种实现，没有绝对的最优的选择，但代码都有相对合理的位置，请注意下面两个问题。
- 找到最适合实现这个功能的模块
- 找到最适合编写这行代码的位置


### 格式
#### 行长度
- 每一行代码字符数不超过80字符，命令行示例或者`URL`除外。

#### 空格还是制表位
- 缩进只用空格不用制表符，每次缩进2空格。

#### 函数申明和定义
- 函数不建议超过200行。
- 函数名与左圆括号之间永远没有空格，右圆括号和左大括号之间总是有一个空格。
- 函数参数列表中，入参在先，出参在后，新加入参数也要按此顺序，但有时需要与其他函数一致。
- 缺省缩进为 2 个空格，换行后的参数保持 4 个空格的缩进。

#### 分支判断
- `if/else/while/for/switch`等条件语句与左圆括号有空格
- 条件语句或者循环体重如果只有一条语句，也要用大括号括起。
- -左大括号换行写。

#### 指针或引用符号的位置
- 星号或者取地址符号与类型或者变量名挨着都可以，但是建议与变量名挨着。

### 命名
#### 命名通用规则
- 函数命名，变量命名，文件命名要有描述性，少用缩写。但`num`，`dns`，`ip`等常见写法除外。

#### 文件名命名
- 文件名全小写，建议用下划线(`_`)连接。

#### 命名空间
- 命名空间以小写字母命名，并注意和常见的顶级命名空间的名字发生冲突。
- 命名空间不使用缩写，命名空间里的类和结构不缩进，嵌套时每个命名空间独立一行。

#### 类型命名
- 建议每个单词首字母大写，且不包含下划线，类似`MyExcitingClass`。

#### 变量命名
- 变量以及函数参数，统一使用小写字母，单词之间用下划线连接。
- 类中的私有成员变量以下划线开始，如 `string _table_name`，这样函数就可以传入同名参数。
- 结构体的数据成员不一下环线开始, 如`int num_entrires`。
- 循环变量建议用iter作为前缀或者后缀命名变量。

#### 常量命名
- 申明为`constexpr` 或者 `const` 的变量，命名时以全大写并以下划线连接，比如:
```
const int SECONDS_IN_MIN = 60
```
- 或者命名时以`const`开头并且单词用下划线连接，比如：
```
const int const_hours_in_day = 24
```

#### 函数命名
- 常规函数用小写字母以及下划线连接。

#### 枚举命名
- 同宏一致，用全大写和下划线，比如`ENUM_NAME`。

#### 宏命名
- 不要使用宏，如果一定要用，用全大写和下划线。

#### 标签命名
- label可以选用简单常见的单词，比如`out`，`done`，`retry`，`again`，`fail`等。

## 规范
### 头文件
#### `#define`保护
- 所有头文件都应该使用`#define`来防止头文件被多重包含。
- `#define`宏的命名格式应该基于项目代码树的全路径，格式为`<PROJECT>_<PATH>_<FILE>_H_`

#### 前置申明
- 尽量避免使用，如果要用，一定要明确原因。

前置申明的缺点：
- 前置申明隐藏了依赖关系，改动头文件，用户代码会跳过必要的重新编译过程。
- 极端情况下，用前置申明会隐含得改变代码的含义。（见参考文档1.3）

#### 内联函数
```
只有当函数代码小于10行时，才将其定义为内联函数。
```
注意：
- 谨慎对待析构函数的内联，因为析构函数通常比其便面看起来更长。
- 一个经验准则时，内敛包含循环或者`switch`语句的函数通常得不偿失。

#### `#include`路径以及顺序
- 头文件包含建议顺序：相关头文件，`C`库，`C++`库，其他库头文件，本项目内的.h文件，每类内按字母排序。
- 避免使用快捷目录，比如`.`后者`..`

注意：
- 你所依赖的符号(symbols)被哪些头文件所定义，你就应该包含哪些头文件，就算你已经包含的某个头文件中会间接包含那个头文件。
- 但是，如果cc文件对应的相关头文件(即对应的同名h头文件)已经包含那些头文件，那是不需要再次包含进cc文件的。

#### 作用域
- 鼓励在`.cc`文件内使用匿名命名空间，或者`static`申明。


#### 注释
- 函数头部必须注释。
- 命令行相关函数必须要把命令行用法写入注释。
- 单行以及多行注释统一用`//` 出了文件头注释，别处都不用 `/**/。
- 适当使用`TODO`注释。


### 数据访问
#### 指针多层访问
- 如果有多处使用多层指针访问，那么需要用临时变量保持多层指针访问的值，比如循环判断中存在多层指针访问。


### 数据结构
#### class 还是 struct
- 除非只是数据的汇聚且没有完整性约数，否者都用`class`，不要用`struct`。
- 类将所有成员定义为`private`，尽量不要用`public`。

#### 类声明顺序
- 类中声明顺序：类型，常量，工厂函数，构造函数，赋值运算符，析构函数，其他函数，数据成员。

#### 数据强转
- 强转`(uint64_t)-1`这种方式可以接受，社区中有这种写法。


### 函数
#### 函数定义
- 尽量定义无返回值的函数，简化异常处理。
- 函数数入参可以是值参，或`const`引用，或`const`指针，不能是非`const`引用，函数出参一般用指针。

#### 函数的参数
- 函数参数中，多个参数尽量在参数内部有重复的字段。
比如：
```
void DataManager::dm_write_obj_data(
  const hobject_t &hobj,
  const dm_data_oper_t &oper,
  const bufferlist &data
  )
```
这个接口中，`hobject_t` 和 `dm_data_oper_t` 两个参数类型中有相同的字段`object_t oid`, `string nspace`，设计不够好。
但是这个接口调用的接口需要hobject_t类型。即有时，函数内部依赖的其他接口的参数要求，导致我们设计的函数参数选择有限。

#### 函数流控
- 一个函数内条件语句嵌套不要超过2层，超过考虑用反向处理。
- 支持受限使用`goto`。

#### 内联控制
- 类函数如果不打算内联，就不要放在头文件里，而是放到对应的`cc`文件里，贯彻定义和声明分离原则。

#### 分支循环
- `for`或`while`的空循环体用空括号或者`continue`，不要只写一个分号。
- `switch-case`中的`default`中如果永远执行不到，应该加条`assert`，每一个`case`可以用大括号括起。
- 多重循环，最忙的循环放在最内层。
- 一般写成`if (ptr)` 而不是 `if (ptr != nullptr)`。


## 惯用实践
### 断言的使用
### C++语法特性
#### 多用const
- 比如 `for (const auto& kv : metadata)`，注意`const`。

#### 多用列表初始化
- 可以用列表来初始化数组和结构体，在`C++03/C++11`中任何对象都可以。

#### 用nullptr指针
- 整数用`0`，实数用`0.0`，指正用`NULL`（`C++03`项目）或者`nullptr`（`C++11`项目）。

###  规格
#### 字串长度规格
- 建议字符串长度规格设计成2的幂次方-1，即不包括字符串结尾的`\0`。


### 日志
当我们在代码中添加一行日志的时候，问自己一个问题：这行日志是为了定位什么问题。
我们添加日志，不是为了随便打印一些数据字段，而是去预判可能会出问题的地方，比如调用第三方接口可能会超时没有返回。
或者，我们需要标记当前被挂起的的具体的某个信号量，而不是只是打印有信号量被挂起。
当我们明确添加的每一行日志所针对的的问题时，我们的日志添加就会更加合理和有效。

#### 接口日志的完备性
- 一个接口中的日志尽量做到MECE原则，即是相互独立，完全穷尽。

在一个接口中，我们不要打印重复的数据字段，除非这个数据的值发生变化而且有必要。
也不要一行打印一个或几个字段，而是有效组织单行日志，让一行日志成为一个整体，每一行日志都有针对诊断某个问题。
所以，每一行日志都有关键信息的同时，尽量能组织更多的信息，减少接口中日志代码的行数，减少日志对模块性能的影响。


有时候，为了方便对日志进行行过滤，会在接口中的大多数行中打印相同的信息，比如都打印对象名方便过滤。
但是我个人觉得，这不是一个好的办法，这违反MECE原则。
如果我们要查看某个特定对象在该接口中的处理情况，我们可以通过`grep -A/-B/-C`等选项达到类似的效果。

#### 分割符号
- 日志中建议多用冒号，逗号和分号进行分割，日志更清晰。


## 代码自查
### 代码写完后的自我检查
#### 对每一个可能走到这行代码的流程：
- 这行代码对线程的同步异步是否有影响。
- 这行代码对流程的异常处理是否有影响。
- 这行代码对这个流程的性能是否有影响。

#### 对于受这行代码影响的每一项数据：
- 检查下这些数据是否有关联的数据需要同步修改。
- 检查下访问到这些数据的其他流程是否受到影响。


### 问题单电子流
#### 验证报告
- 验证报告应该实际操作确认，尽量完全模拟提单的流程步骤。
- 对于有的难以复现的问题单，可以考虑用单元测试进行覆盖。
